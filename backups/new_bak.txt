<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            background-image: url("assets/bg.jpg");
            background-repeat: repeat;
            background-size: 15cm;
            margin: 0;
        }

        #inv-cont {
            position: fixed;
            top: 0;
            left: 0;
            width: auto;
            padding: 0;
            z-index: 10;
            background-color: rgba(4,158,129,0.5);
            border: 10px double darkcyan;
            border-radius: 20px;
        }

        #inv {
            display: grid;
            grid-template-columns: repeat(13, 50px); /* 13 items per row */
            gap: 6px;
            padding: 10px;
        }

        .inv-item {
            width: 40px;
            height: 40px;
            background-color: darkgrey;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid cyan;
            border-radius: 5px;
            overflow: hidden;
            cursor: pointer;
        }

        .inv-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #grid {
            display: grid;
            grid-template-columns: repeat(100, 40px); /* 100 columns with each cell 40px wide */
            grid-template-rows: repeat(100, 40px);    /* 100 rows with each cell 40px tall */
            gap: 1px;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }

        .grid-cell {
            width: 40px;
            height: 40px;
            background-color: rgba(100,255,255,0.07);
            border: 1px solid rgba(60,50,120,0.5);
            position: relative; /* For positioning steam puffs */
            overflow: hidden;
        }

        .grid-cell img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .steam-highlight {
            background-color: rgba(0, 255, 0, 0.3);
        }

        .steam-puff {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(0, 255, 0, 0.6); /* Translucent green for steam */
            border-radius: 50%;
            pointer-events: none; /* Ensure it doesn't block clicks */
        }

        @keyframes puff-animation {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        #toggle-hint {
            display: none;
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 10;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }

        #load-button {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 20;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        #load-button input[type="file"] {
            display: none;
        }

        .activators {
            position: absolute;
            z-index: 1;
            font-size: 0.6cm;
            border: none;
            background: none;
            cursor: pointer;
        }

        .activators:hover {
          
        }
		
		.steam-puff{
			width:100%;
			height:100%;
			background-color:green;
			opacity:0.7;
			color:black;
			font-size:0.7cm;
			text-align:center;
			font-weight:bold;
			border-radius:0px;
			animation:flash 1s linear infinite;
		}
		
		@keyframes flash{
		0%{background-color:green;}
		50%{background-color:white;}
		100%{background-color:green;}
		}
    </style>
</head>

<body>
    <div id="inv-cont">
        <div id="inv"></div>
    </div>

    <div id="grid"></div>

    <!-- Hint text for showing inventory -->
    <div id="toggle-hint">Press I to open Inventory</div>

    <!-- Load JSON Button -->
    <button id="load-button" alt="ctrl+s to save json">Load JSON</button>
    <input type="file" id="file-input" accept=".json" style="display: none;">

    <script>
		function unique(length) {
		let result = '';
		const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
		const charactersLength = characters.length;
		let counter = 0;
		while (counter < length) {
		  result += characters.charAt(Math.floor(Math.random() * charactersLength));
		  counter += 1;
		}
		return result;
	}

        let inventoryVisible = false;

        function toggleInventory() {
            const invCont = document.getElementById('inv-cont');
            const toggleHint = document.getElementById('toggle-hint');
            
            if (inventoryVisible) {
                invCont.style.display = 'none';
                toggleHint.style.display = 'block'; // Show the hint text
            } else {
                invCont.style.display = 'block';
                toggleHint.style.display = 'none'; // Hide the hint text
            }

            inventoryVisible = !inventoryVisible; // Toggle state
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'i' || event.key === 'I') {
                toggleInventory();
            }
            if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                event.preventDefault(); // Prevent the default save dialog
                saveGrid();
            }
        });

        const activators = [
            { name: "steam engine" },
            { name: "steam revolver" },
            { name: "steam stomper" }
        ];
        const items = [
            { name: "steam tubes" },
            { name: "steam bellows" },
            { name: "steam riser bellows" },
            { name: "steam piston" },
            { name: "steam lifter piston" },
            { name: "steam collector" },
            { name: "steam engine" },
            { name: "steam crank" },
            { name: "steam crossover" },
            { name: "steam funnel up" },
            { name: "steam funnel down" },
            { name: "steam funnel left" },
            { name: "steam funnel right" },
            { name: "steam gear" },
            { name: "steam organ" },
            { name: "steam pipe" },
            { name: "steam revolver" },
            { name: "steam scrambler" },
            { name: "steam stomper" },
            { name: "steam vent" },
            { name: "steam valve" },
            { name: "steam door" },
            { name: "steam spikes" },
            { name: "steam lamp" },
            { name: "steam launcher" },
			{ name: "copper" }
        ];

        let selectedItem = null;
        let gridData = Array.from({ length: 100 }, () => Array(100).fill(null)); // 2D array for grid

        const inv = document.getElementById('inv');
        const grid = document.getElementById('grid');
        const fileInput = document.getElementById('file-input');

        items.forEach(item => {
            const div = document.createElement('div');
            div.classList.add('inv-item');
            
            const img = document.createElement('img');
            img.src = "assets/" + item.name.toLowerCase().replaceAll(" ", "-") + ".png";
            img.alt = item.name;

            div.addEventListener('click', () => {
                selectedItem = { name: item.name, orientation: 0 };
            });

            div.appendChild(img);
            inv.appendChild(div);
        });

        setTimeout(toggleInventory, 1000);
        setTimeout(toggleInventory, 1000);

        for (let i = 0; i < 10000; i++) {
            const cell = document.createElement('div');
			cell.id = `grid-cell-${i}`
            cell.classList.add('grid-cell');

            cell.addEventListener('click', () => placeBlock(cell, i));
            grid.appendChild(cell);
        }

        function placeBlock(cell, i) {
            const row = Math.floor(i / 100);
            const col = i % 100;

            if (cell.hasChildNodes()) {
                cell.innerHTML = '';
                cell.style.border = '1px solid rgba(60,50,120,0.5)';
                gridData[row][col] = "null";

                const existingButton = document.getElementById(`activator-${i}`);
                if (existingButton) {
                    document.body.removeChild(existingButton);
                }
            } else if (selectedItem) {
                const img = document.createElement('img');
                img.src = "assets/" + selectedItem.name.toLowerCase().replaceAll(" ", "-") + ".png";
                img.alt = selectedItem.name;
                cell.appendChild(img);
                cell.style.border = 'none';
                gridData[row][col] = { 
                    name: selectedItem.name, 
                    orientation: selectedItem.orientation,
                    steam: false // Initialize steam status
                };

                if (activators.some(a => a.name === selectedItem.name)) {
                    let button = document.createElement("button");
                    button.id = `activator-${i}`;
                    button.classList.add("activators");
                    button.textContent = "▶️";
                    button.style.top = `${Math.floor(i / 100) * 40}px`;
                    button.style.left = `${(i % 100) * 40}px`;

                    button.addEventListener("click", () => {
                        alert(`Activator clicked at index ${i}`); // Alert for debugging  
                        steamSystem_main(Math.floor(i / 100), i % 100);
                    });

                    document.body.appendChild(button);
                }
            }
        }

        function saveGrid() {
            const gridJson = JSON.stringify(gridData);
            const blob = new Blob([gridJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'grid.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = () => {
                    gridData = JSON.parse(reader.result);
                    updateGridFromData();
                };
                reader.readAsText(file);
            }
        });

        function updateGridFromData() {
            gridData.forEach((row, r) => {
                row.forEach((cell, c) => {
                    const cellDiv = grid.children[r * 100 + c];
                    if (cellDiv) {
                        if (cell) {
                            cellDiv.innerHTML = '';
                            const img = document.createElement('img');
                            img.src = "assets/" + cell.name.toLowerCase().replaceAll(" ", "-") + ".png";
                            img.alt = cell.name;
                            cellDiv.appendChild(img);

                            if (activators.some(a => a.name === cell.name)) {
                                let button = document.createElement("button");
                                button.id = `activator-${r * 100 + c}`;
                                button.classList.add("activators");
                                button.textContent = "▶️";
                                button.style.top = `${r * 40}px`;
                                button.style.left = `${c * 40}px`;

                                button.addEventListener("click", () => {
                                    alert(`Activator clicked at index ${r * 100 + c}`); // Alert for debugging  
                                    steamSystem_main(r, c);
                                });
                                document.body.appendChild(button);
                            }
                        } else {
                            cellDiv.innerHTML = '';
                            cellDiv.style.border = '1px solid rgba(60,50,120,0.5)';
                        }
                    }
                });
            });
        }

        const standard_behaviour = [
            "steam tubes",
            "steam bellows" ,
            "steam riser bellows",
            "steam piston",
            "steam lifter piston",
            "steam gear"
        ];

        function adj(row, col) {
            const adjacent = [];
            const rows = gridData.length;
            const cols = gridData[0].length;
            
            // Up
            adjacent.push(row > 0 ? gridData[row - 1][col] || "null" : "null");
            // Down
            adjacent.push(row < rows - 1 ? gridData[row + 1][col] || "null" : "null");
            // Left
            adjacent.push(col > 0 ? gridData[row][col - 1] || "null" : "null");
            // Right
            adjacent.push(col < cols - 1 ? gridData[row][col + 1] || "null" : "null");
            
            console.log(adjacent);
            return adjacent;
        }
		

		let Steam_Puffs = []
	
		
		
	
	
		
		


		const arrow_mapper = {
			U:"∧",
			D:"∨",
			L:"<",
			R:">"
		}



		const id_length = 5;
		const puff_speed = 100;//0.1s
		
		class Puff {
			constructor(current_direction,position={row:null,col:null},distance_moved=0,collector_max_duration=10,unique_id){
				this.current_direction = current_direction;
				this.position = position
				this.unique_id = unique(id_length);
				this.distance_moved = distance_moved;
				this.collector_max_duration = collector_max_duration;
				this.generate_puff(this.position.row,this.position.col)			
			}
			
			//generate a new steam puff visually
			generate_puff(row,col){
				 let cell = document.getElementById(`grid-cell-${ parseInt(this.position.row) * 100 + parseInt(this.position.col)}`);
			     if (cell) {
					// Create and display a new steam puff element
					const puffElement = document.createElement('div');
					puffElement.id = "puff-" + this.unique_id
					puffElement.innerHTML = arrow_mapper[this.current_direction]
					puffElement.classList.add('steam-puff');
					puffElement.style.top = '0px'; 
					puffElement.style.left = '0px'; 
					Steam_Puffs.push(this);
					cell.appendChild(puffElement)
					setTimeout(()=>{this.recursive_move()},puff_speed)
				 }
	 
		}
		
		//recursive motion function
			recursive_move(){
				let adjCells = adj(this.position.row,this.position.col);
				let ValidArr = {
				U:standard_behaviour.includes(adjCells[0] === "null" ? "null" : adjCells[0].name), //up
				D:standard_behaviour.includes(adjCells[1] === "null" ? "null" : adjCells[1].name), //down
				L:standard_behaviour.includes(adjCells[2] === "null" ? "null" : adjCells[2].name), //left
				R:standard_behaviour.includes(adjCells[3] === "null" ? "null" : adjCells[3].name) //right
				}
				if(this.current_direction=="U"){
				 ValidArr.D = "null"
				}
				if(this.current_direction=="D"){
				 ValidArr.U = "null"
				}
				if(this.current_direction=="L"){
				 ValidArr.L = "null"
				}
				if(this.current_direction=="R"){
				 ValidArr.R = "null"
				}
				
				if(ValidArr[this.current_direction]==true){
					console.log("straight line motion");
					if(this.current_direction=="U")
						this.changePosition("U",this.position.row-1,this.position.col);
					if(this.current_direction=="D")
						this.changePosition("D",this.position.row+1,this.position.col);
					if(this.current_direction=="L")
						this.changePosition("L",this.position.row,this.position.col-1);
					if(this.current_direction=="R")
						this.changePosition("R",this.position.row,this.position.col+1);
						
					setTimeout(()=>{this.recursive_move()},puff_speed)
				}
				else if(1==1){
					console.log("not straight")
				}
			}
			
			
			//change puff position in grid
				changePosition(newDirection, newRow, newCol) {
				// Get the current cell and new cell in the grid
				const currentCell = document.getElementById(`grid-cell-${this.position.row * 100 + this.position.col}`);
				const newCellIndex = newRow * 100 + newCol;
				const newCell = document.getElementById(`grid-cell-${newCellIndex}`);

				// Find the puff element in the current cell
				const puffElement = document.getElementById(`puff-${this.unique_id}`);
				if (puffElement) {
					// Remove puff element from the current cell
					if (currentCell) {
						currentCell.removeChild(puffElement);
					}

					// Append puff element to the new cell
					if (newCell) {
						puffElement.style.top = "0px"
						puffElement.style.left = "0px"
						this.current_direction = newDirection;
						puffElement.innerHTML = arrow_mapper[this.current_direction]
						newCell.appendChild(puffElement);
					}

					// Update puff's position
					this.position = {row:newRow, col:newCol};
				}
			}

		}

		
			
			

        function steamSystem_main(act_r, act_c) {        
            console.log(gridData);
            const adjCells = adj(act_r, act_c);

            
            adjCells.forEach((cell, index) => {
                console.log(`Adjacent ${index}: ${cell === "null" ? "null" : cell.name}`);
            });

            if (standard_behaviour.includes(adjCells[0] === "null" ? "null" : adjCells[0].name)) {
                alert('up');
				let _puff = new Puff("U",{row:act_r-1,col:act_c})
            }
			else if (standard_behaviour.includes(adjCells[1] === "null" ? "null" : adjCells[1].name)) {
                alert('down');
				let _puff = new Puff("D",{row:act_r+1,col:act_c})
            }
			else{
				//nowhere to propagate to
			}
        }
		
		const loadButton = document.getElementById('load-button');
loadButton.addEventListener('click', () => {
    fileInput.click();
});
    </script>
</body>
</html>
